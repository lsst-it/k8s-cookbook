alloy:
  controller:
    type: daemonset

  mounts:
    varlog: true

  # Required because filelog is a Public preview component
  stabilityLevel: public-preview

  configMap:
    content: |
      logging {
        level  = "info"
        format = "logfmt"
      }

      otelcol.receiver.filelog "k8s" {
        include             = ["/var/log/containers/*.log"]
        start_at            = "end"
        include_file_path   = true
        include_file_path_resolved = true
        include_file_name   = true
        operators = [
          { type = "container" },
        ]

        output {
          logs = [otelcol.processor.k8sattributes.k8sattrs.input]
        }
      }

      otelcol.processor.k8sattributes "k8sattrs" {
        wait_for_metadata = true
        extract {
          metadata = [
            "k8s.namespace.name",
            "k8s.pod.name",
            "k8s.pod.uid",
            "k8s.node.name",
            "k8s.container.name",
          ]
        }
        output { logs = [otelcol.processor.batch.main.input] }
      }

      otelcol.processor.batch "main" {
        output { logs = [otelcol.exporter.otlphttp.to_alloy.input] }
      }

      otelcol.exporter.otlphttp "to_alloy" {
        client {
          endpoint = "https://alloy.kona.dev.lsst.org:4318"
        }
      }
