alloy:
  controller:
    type: daemonset

  mounts:
    varlog: true

  # Required because filelog is a Public preview component
  stabilityLevel: public-preview

  configMap:
    content: |
      logging {
        level  = "info"
        format = "logfmt"
      }

      otelcol.receiver.filelog "k8s" {
        include             = [
          "/var/log/containers/*.log",
          "/var/log/pods/*/*/*.log",
        ]
        start_at            = "end"
        include_file_path  = true
        include_file_name  = true
        operators = [
          { 
            type                         = "container",
            add_metadata_from_filepath   = false,
            on_error                     = "send",
          },
        ]

        output {
          logs = [otelcol.processor.batch.main.input]
        }
      }

      otelcol.processor.batch "main" {
        output { logs = [otelcol.exporter.otlphttp.to_alloy.input] }
      }

      otelcol.exporter.otlphttp "to_alloy" {
        client {
          endpoint = "http://alloy.kona.dev.lsst.org:4318"
        }
      }
