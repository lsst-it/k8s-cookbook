---
deploymentMode: Distributed

gateway:
  enabled: true
  replicas: 3
  ingress:
    enabled: true
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
      nginx.ingress.kubernetes.io/backend-protocol: HTTP
      nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
      nginx.ingress.kubernetes.io/client-body-buffer-size: 10m
    hosts:
      - host: loki.${ .ClusterLabels.site }.lsst.org
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: tls-loki-ingress
        hosts:
          - loki.${ .ClusterLabels.site }.lsst.org

global:
  dnsService: rke2-coredns-rke2-coredns
  extraEnv:
    - name: AWS_ACCESS_KEY_ID
      valueFrom:
        secretKeyRef:
          name: rook-ceph-object-user-o11y-loki
          key: AccessKey
    - name: AWS_SECRET_ACCESS_KEY
      valueFrom:
        secretKeyRef:
          name: rook-ceph-object-user-o11y-loki
          key: SecretKey

loki:
  auth_enabled: false
  commonConfig:
    replication_factor: 3

  storage:
    type: s3
    s3:
      endpoint: http://rook-ceph-rgw-o11y.rook-ceph.svc.cluster.local
      region: o11y
      s3ForcePathStyle: true
    bucketNames:
      chunks: loki-chunks
      ruler: loki-ruler
      admin: loki-admin

  schemaConfig:
    configs:
      - from: "2025-03-01"
        store: tsdb
        object_store: s3
        schema: v13
        index:
          prefix: loki_index_
          period: 24h

  compactor:
    retention_enabled: true
    working_directory: /var/loki/compactor
    delete_request_store: s3

  query_range:
    cache_results: true
    results_cache:
      cache:
        enable_fifocache: false
        memcached:
          addresses: dns+loki-results-cache.loki.svc.cluster.local:11211
          max_item_size: 1MiB
          timeout: 500ms

  limits_config:
    retention_period: 90d
    ingestion_rate_mb: 50
    ingestion_burst_size_mb: 100
    max_global_streams_per_user: 500000
    max_label_names_per_series: 30
    reject_old_samples_max_age: 168h
    query_timeout: 4m
    max_entries_limit_per_query: 50000

distributor:
  replicas: 3
  maxUnavailable: 2
  resources:
    requests: { cpu: 500m, memory: 512Mi }
    limits: { cpu: 2, memory: 2Gi }

ingester:
  replicas: 6
  maxUnavailable: 1
  persistence:
    enabled: true
    claims:
      - name: data
        accessModes:
          - ReadWriteOnce
        size: 30Gi
  resources:
    requests: { cpu: 1, memory: 2Gi }
    limits: { cpu: 4, memory: 8Gi }

querier:
  replicas: 4
  maxUnavailable: 3
  resources:
    requests: { cpu: 500m, memory: 1Gi }
    limits: { cpu: 2, memory: 4Gi }

queryFrontend:
  replicas: 3
  maxUnavailable: 1
  resources:
    requests: { cpu: 200m, memory: 512Mi }
    limits: { cpu: 1, memory: 2Gi }

queryScheduler:
  replicas: 3
  maxUnavailable: 1
  resources:
    requests: { cpu: 200m, memory: 512Mi }
    limits: { cpu: 1, memory: 2Gi }

compactor:
  replicas: 2
  persistence:
    enabled: true
    storageClassName: rook-ceph-block
  resources:
    requests: { cpu: 500m, memory: 1Gi }
    limits: { cpu: 2, memory: 4Gi }

indexGateway:
  replicas: 3
  maxUnavailable: 1
  resources:
    requests: { cpu: 200m, memory: 512Mi }
    limits: { cpu: 1, memory: 2Gi }

resultsCache:
  enabled: true
  replicas: 3
  resources:
    requests: { cpu: 200m, memory: 256Mi }
    limits: { cpu: 1, memory: 1Gi }

chunksCache:
  enabled: true
  replicas: 3
  resources:
    requests: { cpu: 200m, memory: 256Mi }
    limits: { cpu: 1, memory: 1Gi }

# needed by helm
read:
  replicas: 0
write:
  replicas: 0
backend:
  replicas: 0

monitoring:
  serviceMonitor:
    enabled: true
    labels:
      lsst.io/monitor: "true"
