---
defaultNamespace: external-secrets
namespaceLabels:
  lsst.io/discover: "true"
labels:
  bundle: &name external-secrets-conf
helm:
  releaseName: *name
  waitForJobs: true
  values:
    site: ${ .ClusterLabels.site }
    vaults:
      ${ .ClusterName }.${ .ClusterLabels.site }: 1
      k8s-${ .ClusterLabels.site }: 2
      k8s-common: 3
dependsOn:
  - selector:
      matchLabels:
        bundle: external-secrets
targetCustomizations:
  - name: rancher-cluster
    clusterSelector:
      matchExpressions:
        # all rancher clusters have the name local and this value can not be changed
        - key: management.cattle.io/cluster-name
          operator: In
          values:
            - local
    helm:
      values:
        vaults:
          # helm merges the maps, so we need to remove the default 1 vault
          ${ .ClusterName }.${ .ClusterLabels.site }: ~
          # it probaly would have been easier to name the vaults local.<site>...
          rancher.${ .ClusterLabels.site }: 1
