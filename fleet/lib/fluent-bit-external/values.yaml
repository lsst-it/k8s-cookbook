# kind -- DaemonSet or Deployment
kind: Deployment

# replicaCount -- Only applicable if kind=Deployment
replicaCount: 2

image:
  repository: cr.fluentbit.io/fluent/fluent-bit
  digest:
  pullPolicy: IfNotPresent

serviceMonitor:
  enabled: true
  selector:
    lsst.io/monitor: "true"

prometheusRule:
  enabled: true
  namespace: ""
  additionalLabels:
    lsst.io/rule: "true"
  rules:
  - alert: NoOutputBytesProcessed
    expr: rate(fluentbit_output_proc_bytes_total[5m]) == 0
    annotations:
      message: |
        Fluent Bit instance {{ $labels.instance }} output plugin {{ $labels.name
        }} has not processed any bytes for at least 15 minutes.
      summary: No Output Bytes Processed
    for: 15m
    labels:
      severity: critical

dashboards:
  enabled: true
  labelKey: grafana_dashboard
  labelValue: 1
  annotations: {}
  namespace: ""

resources:
  limits:
    cpu: 200m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

## only available if kind is Deployment
podDisruptionBudget:
  enabled: false
  annotations: {}
  maxUnavailable: 30%

labels:
  lsst.team.io/infra: "true"
  lsst.io/role: logging
  lsst.io/component: fluent-bit
  lsst.io/env: external
  lsst.io/project: o11y

podLabels:
  lsst.team.io/infra: "true"
  lsst.io/role: logging
  lsst.io/component: fluent-bit
  lsst.io/env: external
  lsst.io/project: o11y

flush: 1

metricsPort: 2020

extraPorts:
- port: 5140
  containerPort: 5140
  protocol: TCP
  name: rsyslog-tcp
- port: 5140
  containerPort: 5140
  protocol: UDP
  name: rsyslog-udp
- port: 5141
  containerPort: 5141
  protocol: TCP
  name: firewall-tcp
- port: 5141
  containerPort: 5141
  protocol: UDP
  name: firewall-udp
- port: 5142
  containerPort: 5142
  protocol: TCP
  name: network-tcp
- port: 5142
  containerPort: 5142
  protocol: UDP
  name: network-udp

extraVolumes:
- name: db
  emptyDir:
    sizeLimit: 128Mi
- name: cert
  secret:
    defaultMode: 420
    secretName: rsyslog-cert

extraVolumeMounts:
- name: db
  mountPath: /fluent-bit/db
- name: cert
  mountPath: /etc/secrets/certicate
  readOnly: true

## https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/classic-mode/configuration-file
config:
  service: |
    [SERVICE]
        Daemon Off
        Flush {{ .Values.flush }}
        Log_Level {{ .Values.logLevel }}
        Parsers_File /fluent-bit/etc/parsers.conf
        Parsers_File /fluent-bit/etc/conf/custom_parsers.conf
        HTTP_Server On
        HTTP_Listen 0.0.0.0
        HTTP_Port {{ .Values.metricsPort }}
        Health_Check On

  ## https://docs.fluentbit.io/manual/pipeline/inputs
  inputs: |
    # host syslog
    [Input]
        Name   syslog
        Tag    rsyslog.tcp.*
        Listen 0.0.0.0
        Port   5140
        Mode   tcp
        Parser syslog-rfc3164
        tls          on
        tls.verify   off
        tls.crt_file /etc/secrets/certicate/tls.crt
        tls.key_file /etc/secrets/certicate/tls.key
    # firewall logs
    [Input]
        Name   syslog
        Tag    firewall.tcp.*
        Listen 0.0.0.0
        Port   5141
        Mode   tcp
        Parser syslog-rfc5424
        tls          on
        tls.verify   off
        tls.crt_file /etc/secrets/certicate/tls.crt
        tls.key_file /etc/secrets/certicate/tls.key
    [Input]
        Name   syslog
        Tag    firewall.udp.*
        Listen 0.0.0.0
        Port   5141
        Mode   udp
        Parser syslog-rfc5424
    # network logs
    [Input]
        Name   syslog
        Tag    network.tcp.*
        Listen 0.0.0.0
        Port   5142
        Mode   tcp
        Parser syslog-rfc3164
        tls          on
        tls.verify   off
        tls.crt_file /etc/secrets/certicate/tls.crt
        tls.key_file /etc/secrets/certicate/tls.key
    [Input]
        Name   syslog
        Tag    network.udp.*
        Listen 0.0.0.0
        Port   5142
        Mode   udp
        Parser syslog-rfc3164

  ## https://docs.fluentbit.io/manual/pipeline/filters
  filters: |
    [FILTER]
        Name rewrite_tag
        Match rsyslog.*
        Rule $ident "sudo" sudo.$host.$ident true
        Emitter_Name rewrite_sudo_emitter
        Emitter_Storage.type memory

    [FILTER]
        Name parser
        Match sudo.*
        Parser sudo_parser
        Key_Name message
        Preserve_Key true
        Reserve_Data true

    [FILTER]
        Name grep
        Match sudo.*
        Regex user .*

    [FILTER]
        Name grep
        Match sudo.*
        Regex command .*

    [FILTER]
        Name modify
        Match sudo.*
        Add alertname sudoLog
        Add receivers ,slack,
        Add log_type sudo
        Add source external
        Rename message full_log

    [FILTER]
        Name modify
        Match rsyslog.*
        Add log_type rsyslog
        Add source external

    [FILTER]
        Name modify
        Match audit.*
        Add log_type audit
        Add source external

    [FILTER]
        Name modify
        Match syslog.*
        Add log_type syslog
        Add source external

    [FILTER]
        Name   parser
        Match  firewall.*
        Key_Name msg
        Parser pfsense_syslog_parser
        Preserve_Key true
        Reserve_Data true

    [FILTER]
        Name   modify
        Match  firewall.*
        Add    log_type firewall
        Add    source   external
        Rename msg full_log
        Remove anchor
        Remove offset
        Remove urg

    [FILTER]
        Name modify
        Match network.*
        Add log_type network
        Add source external

  ## https://docs.fluentbit.io/manual/pipeline/parsers
  customParsers: |
    [PARSER]
      Name systemd_session_parser
      Format regex
      Regex ^(?<pam_module>[\w]*)\((?<command>[\w\-:]*)\)?\: session opened for user root\(uid=(?<uid>[\d*])\) by \(uid=(?<user_uid>[\d*])\)$
      Types uid:integer user_uid:integer

    [PARSER]
      Name sudo_parser
      Format regex
      Regex ^(?<user>[\w]+)\s*:?\s*(?<notification>[\w\s]+)\s*;?\s*TTY=(?<tty>[\w\/]+)\s*;?\s*PWD=(?<working_directory>[\w\/]+)\s*;?\s*USER=(?<sudo_user>[\w]+)\s*;?\s*COMMAND=(?<command>.+)$

    [PARSER]
      Name        pfsense_syslog_parser
      Format      regex
      Regex       ^.*\[fwlog\] (?<rule_id>[^,]*),(?<sub_rule>[^,]*),(?<anchor>[^,]*),(?<tracker>[^,]*),(?<iface>[^,]*),(?<reason>[^,]*),(?<action>[^,]*),(?<dir>[^,]*),(?<ipver>[^,]*),(?<tos>[^,]*),(?<ecn>[^,]*),(?<ttl>[^,]*),(?<id>[^,]*),(?<offset>[^,]*),(?<flags>[^,]*),(?<proto_id>[^,]*),(?<proto>[^,]*),(?<len>[^,]*),(?<src_ip>[^,]*),(?<dst_ip>[^,]*),(?<src_port>[^,]*),(?<dst_port>[^,]*),(?<data_len>[^,]*),(?<tcp_flags>[^,]*),(?<seq>[^,]*),(?<ack>[^,]*),(?<window>[^,]*),(?<urg>[^,]*),(?<options>[^,\n]*)$
      Time_Keep   On

# The config volume is mounted by default, either to the existingConfigMap value, or the default of "fluent-bit.fullname"
volumeMounts:
- name: config
  mountPath: /fluent-bit/etc/conf

daemonSetVolumes:
- name: varlog
  hostPath:
    path: /var/log
- name: varlibdockercontainers
  hostPath:
    path: /var/lib/docker/containers
- name: etcmachineid
  hostPath:
    path: /etc/machine-id
    type: File

daemonSetVolumeMounts:
- name: varlog
  mountPath: /var/log
- name: varlibdockercontainers
  mountPath: /var/lib/docker/containers
  readOnly: true
- name: etcmachineid
  mountPath: /etc/machine-id
  readOnly: true

command:
- /fluent-bit/bin/fluent-bit

args:
- --workdir=/fluent-bit/etc
- --config=/fluent-bit/etc/conf/fluent-bit.conf

logLevel: info

hotReload:
  enabled: true
  image:
    repository: ghcr.io/jimmidyson/configmap-reload
    tag: v0.11.1
    digest:
    pullPolicy: IfNotPresent
  resources:
    requests:
      cpu: 100m
      memory: 60Mi
    limits:
      cpu: 100m
      memory: 60Mi
